import {
  Canvas,
  Fill,
  Shader,
  SkRuntimeEffect,
} from "@shopify/react-native-skia";
import React from "react";
import { View, LayoutChangeEvent } from "react-native";
import {
  useDerivedValue,
  useFrameCallback,
  useSharedValue,
} from "react-native-reanimated";

type Props = {
  // SkRuntimeEffect ‚Äî —Ü–µ –≤–∂–µ —Å–∫–æ–º–ø—ñ–ª—å–æ–≤–∞–Ω–∏–π –∫–æ–¥ –Ω–∞—à–æ–≥–æ —à–µ–π–¥–µ—Ä–∞ (–∑ —Ñ–∞–π–ª—ñ–≤ .sksl).
  // –í—ñ–Ω –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è —Å—é–¥–∏ –∑ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ App.
  effect: SkRuntimeEffect;
};

export function ShaderCanvas({ effect }: Props) {
  // =========================================================================
  // 1. SHARED VALUES (–°–ø—ñ–ª—å–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è)
  // =========================================================================
  // –ó–∞–º—ñ—Å—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ React.useState() –º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ useSharedValue().
  // –ß–æ–º—É? –¢–æ–º—É —â–æ useState –ø—Ä–∏ –∫–æ–∂–Ω—ñ–π –∑–º—ñ–Ω—ñ –∑–º—É—à—É—î React –ø–µ—Ä–µ–º–∞–ª—å–æ–≤—É–≤–∞—Ç–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç.
  // –î–ª—è –∞–Ω—ñ–º–∞—Ü—ñ–π (60-120 –∫–∞–¥—Ä—ñ–≤ –Ω–∞ —Å–µ–∫—É–Ω–¥—É) —Ü–µ –∑–∞–Ω–∞–¥—Ç–æ –ø–æ–≤—ñ–ª—å–Ω–æ —ñ "–∑–∞–±–∏–≤–∞—î" JS-–ø–æ—Ç—ñ–∫.
  // useSharedValue –∂–∏–≤–µ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤ UI-–ø–æ—Ç–æ—Ü—ñ, —Ç–æ–º—É –ø—Ä–∞—Ü—é—î –±–ª–∏—Å–∫–∞–≤–∏—á–Ω–æ.

  // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ä–æ–∑–¥—ñ–ª—å–Ω—É –∑–¥–∞—Ç–Ω—ñ—Å—Ç—å –µ–∫—Ä–∞–Ω—É/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —É —Ñ–æ—Ä–º–∞—Ç—ñ: [—à–∏—Ä–∏–Ω–∞, –≤–∏—Å–æ—Ç–∞]
  const res = useSharedValue<[number, number]>([0, 0]);

  // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —á–∞—Å, —è–∫–∏–π –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è —Ç–æ–≥–æ, —â–æ–± —à–µ–π–¥–µ—Ä –º—ñ–≥ –∞–Ω—ñ–º—É–≤–∞—Ç–∏—Å—è (—Ä—É—Ö–∞—Ç–∏—Å—è)
  const time = useSharedValue(0);

  // =========================================================================
  // 2. –ê–ù–Ü–ú–ê–¶–Ü–ô–ù–ò–ô –¶–ò–ö–õ (Frame Callback)
  // =========================================================================
  // useFrameCallback ‚Äî —Ü–µ —è–∫ –Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–∏–π —Ü–∏–∫–ª (requestAnimationFrame —É –≤–µ–±—ñ),
  // —è–∫–∏–π –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è —â–æ—Ä–∞–∑—É, –∫–æ–ª–∏ –µ–∫—Ä–∞–Ω –º–∞–ª—é—î –Ω–æ–≤–∏–π –∫–∞–¥—Ä.
  useFrameCallback((frameInfo) => {
    // frameInfo.timeSinceFirstFrame –ø–æ–≤–µ—Ä—Ç–∞—î —á–∞—Å —É –º—ñ–ª—ñ—Å–µ–∫—É–Ω–¥–∞—Ö.
    // –û—Å–∫—ñ–ª—å–∫–∏ –≤ –º–∞—Ç–µ–º–∞—Ç–∏—Ü—ñ —à–µ–π–¥–µ—Ä—ñ–≤ (SkSL/GLSL) –∑–∞–∑–≤–∏—á–∞–π –ø—Ä–∞—Ü—é—é—Ç—å —ñ–∑ —Å–µ–∫—É–Ω–¥–∞–º–∏,
    // –º–∏ –¥—ñ–ª–∏–º–æ —Ü–µ –∑–Ω–∞—á–µ–Ω–Ω—è –Ω–∞ 1000.
    time.value = (frameInfo.timeSinceFirstFrame ?? 0) / 1000;
  });

  // =========================================================================
  // 3. UNIFORMS (–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–∏—Ö —É –≤—ñ–¥–µ–æ–∫–∞—Ä—Ç—É)
  // =========================================================================
  // –®–µ–π–¥–µ—Ä ‚Äî —Ü–µ –ø—Ä–æ–≥—Ä–∞–º–∞, —è–∫–∞ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –Ω–∞ GPU (–≤—ñ–¥–µ–æ–∫–∞—Ä—Ç—ñ).
  // "Uniforms" (—É–Ω—ñ—Ñ–æ—Ä–º–∏) ‚Äî —Ü–µ —Å–ø–æ—Å—ñ–± –ø–µ—Ä–µ–¥–∞—Ç–∏ –∑–º—ñ–Ω–Ω—ñ –∑ –Ω–∞—à–æ–≥–æ JavaScript –∫–æ–¥—É
  // –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤ –∫–æ–¥ —à–µ–π–¥–µ—Ä–∞.
  // useDerivedValue —Å—Ç–≤–æ—Ä—é—î –Ω–æ–≤–µ "—Å–ø—ñ–ª—å–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è", —è–∫–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è,
  // –∫–æ–ª–∏ –∑–º—ñ–Ω—é—î—Ç—å—Å—è res.value –∞–±–æ time.value.
  const uniforms = useDerivedValue(() => {
    return {
      u_resolution: res.value, // –ü–µ—Ä–µ–¥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω—É —à–∏—Ä–∏–Ω—É —Ç–∞ –≤–∏—Å–æ—Ç—É —à–µ–π–¥–µ—Ä—É
      u_time: time.value, // –ü–µ—Ä–µ–¥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —á–∞—Å, —â–æ–± —à–µ–π–¥–µ—Ä –∑–Ω–∞–≤, —è–∫ –º–∞–ª—é–≤–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫–∞–¥—Ä
    };
  });

  // =========================================================================
  // 4. –û–ë–†–û–ë–ö–ê –†–û–ó–ú–Ü–†–Ü–í (onLayout)
  // =========================================================================
  // –ö–æ–ª–∏ View –≤–ø–µ—Ä—à–µ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å—Å—è –Ω–∞ –µ–∫—Ä–∞–Ω—ñ, –º–∏ —â–µ –Ω–µ –∑–Ω–∞—î–º–æ –π–æ–≥–æ —Ç–æ—á–Ω–∏—Ö —Ä–æ–∑–º—ñ—Ä—ñ–≤ —É –ø—ñ–∫—Å–µ–ª—è—Ö.
  // –ü–æ–¥—ñ—è onLayout —Å–ø—Ä–∞—Ü—å–æ–≤—É—î, —â–æ–π–Ω–æ React Native –æ–±—á–∏—Å–ª—é—î —Ä–æ–∑–º—ñ—Ä–∏ –±–ª–æ–∫—É.
  const handleLayout = (e: LayoutChangeEvent) => {
    const { width, height } = e.nativeEvent.layout;
    console.log("üöÄ ~ width:", Math.round(width));
    console.log("üöÄ ~ height:", Math.round(height));
    // –û–Ω–æ–≤–ª—é—î–º–æ –Ω–∞—à–µ useSharedValue –∑–Ω–∞—á–µ–Ω–Ω—è.
    // –¶–µ –º–∏—Ç—Ç—î–≤–æ –ø–µ—Ä–µ–¥–∞—Å—Ç—å –Ω–æ–≤—ñ —Ä–æ–∑–º—ñ—Ä–∏ –≤ —à–µ–π–¥–µ—Ä —á–µ—Ä–µ–∑ u_resolution.
    res.value = [Math.round(width), Math.round(height)];
  };

  return (
    // –ì–æ–ª–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä. flex: 1 –æ–∑–Ω–∞—á–∞—î "–∑–∞–π–Ω—è—Ç–∏ –≤–µ—Å—å –≤—ñ–ª—å–Ω–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä –±–∞—Ç—å–∫–∞"
    <View style={{ flex: 1 }} onLayout={handleLayout}>
      {/* Canvas ‚Äî —Ü–µ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤—ñ–¥ Skia, —è–∫–∏–π —Å—Ç–≤–æ—Ä—é—î "–ø–æ–ª–æ—Ç–Ω–æ" –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è */}
      <Canvas style={{ flex: 1 }}>
        {/* Fill –∫–∞–∂–µ Skia –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ –≤–µ—Å—å –ø—Ä–æ—Å—Ç—ñ—Ä –ø–æ–ª–æ—Ç–Ω–∞ (Canvas) */}
        <Fill>
          {/* Shader –±–µ—Ä–µ –Ω–∞—à —Å–∫–æ–º–ø—ñ–ª—å–æ–≤–∞–Ω–∏–π –µ—Ñ–µ–∫—Ç (–∫–æ–¥ .sksl) —ñ –Ω–∞—à—ñ –∑–º—ñ–Ω–Ω—ñ (uniforms), 
              —â–æ–± "—Ä–æ–∑—Ñ–∞—Ä–±—É–≤–∞—Ç–∏" —Ü–µ–π Fill –∑–≥—ñ–¥–Ω–æ –∑ –ª–æ–≥—ñ–∫–æ—é —à–µ–π–¥–µ—Ä–∞ */}
          <Shader source={effect} uniforms={uniforms} />
        </Fill>
      </Canvas>
    </View>
  );
}
